# Integration Patterns and Messaging Schema

This document defines the canonical communication patterns and event-driven data contracts for the Trade Weaver platform. It consolidates decisions from ADR-0004 and ADR-0006.

## 1. Core Communication Protocol

The architecture employs a hybrid communication model to leverage the best pattern for different use cases.

-   **Asynchronous Messaging (Primary):** For all critical commands (e.g., trade requests, analysis triggers), the system uses **Google Cloud Pub/Sub**. This provides reliability, durability, and scalability, decoupling the command issuer from the processor. A command is published to a topic and processed asynchronously by the appropriate service.

-   **Synchronous REST API (Secondary):** For simple, read-only queries where an immediate response is required (e.g., fetching broker performance benchmarks), services may expose a secure, synchronous REST API.

## 2. Agent-to-Agent (A2A) Communication

A hybrid approach is used for communication between agents:

-   **Pub/Sub for Decoupled Workflows:** The primary pattern for communication between major, independent system components. The pre-market analysis workflow is the canonical example, where a coordinator fans out jobs to worker agents via Pub/Sub.

-   **ADK Hierarchy for Internal Tasks:** For tightly-coupled logic within a single, complex agent, the Google ADK's native hierarchical control (`sub_agents`, `transfer_to_agent`) is used for simplicity and directness.

## 3. Canonical Event & Messaging Schema

All events are JSON objects with a consistent header and a variable `payload`. This schema acts as the API contract between all components.

```json
{
  "event_id": "{uuid}",
  "event_type": "EVENT_NAME",
  "source": "{source_component_name}", // e.g., "MarketData.NASDAQ", "RiskManager"
  "timestamp_utc": "...",
  "payload": { ... } 
}
```

---

### 3.1. Time-Based Events (The Pacemaker)

*   **Source:** A central scheduler service.

#### `MARKET_OPEN_EVENT`

-   **Purpose:** Signals the official start of the main trading session for a specific exchange.
-   **Triggers Transition:** `AWAITING_MARKET_OPEN` -> `MONITORING_WATCHLIST`.
-   **Payload:**

    ```json
    {
      "exchange_id": "NASDAQ"
    }
    ```

#### `END_OF_DAY_WARNING_EVENT`

-   **Purpose:** Initiates the mandatory end-of-day liquidation process.
-   **Triggers Transition:** `MONITORING_WATCHLIST` or `MANAGING_POSITION` -> `LIQUIDATING_POSITIONS`.
-   **Payload:**

    ```json
    {
      "exchange_id": "NASDAQ"
    }
    ```

---

### 3.2. Signal & Analysis Events

*   **Source:** The `PreMarketAnalysis`.

#### `ENTRY_SIGNAL_TRIGGERED`

-   **Purpose:** Informs the FSM that a high-probability trading setup has been identified from the watchlist.
-   **Triggers Transition:** `MONITORING_WATCHLIST` -> `ENTERING_POSITION`.
-   **Payload:** The full `StockCandidateObject` for the identified trade.

    ```json
    {
      "signal_id": "{signal_uuid}",
      "ticker": "AAPL",
      "exchange_id": "NASDAQ",
      "direction": "LONG", // Inferred from strategy/catalyst
      "entry_confidence": 0.85, // From the ML meta-model
      "strategy_id": "ORB_v1"
      // ... other fields from the StockCandidateObject
    }
    ```

---

### 3.3. Broker & Order Management Events (Feedback Loop)

*   **Source:** The Broker API wrapper service.

#### `ORDER_FILL_CONFIRMATION`

-   **Purpose:** Confirms that an order has been partially or fully executed by the broker.
-   **Triggers Transition:**
    -   On entry order: `ENTERING_POSITION` -> `MANAGING_POSITION`.
    -   On exit order: `EXITING_POSITION` -> `MONITORING_WATCHLIST`.
-   **Payload:**

    ```json
    {
      "order_id": "{broker_order_uuid}",
      "trade_id": "{trade_uuid}",
      "portfolio_id": "{portfolio_uuid}",
      "fill_status": "PARTIAL" or "FULL",
      "filled_quantity": 50,
      "remaining_quantity": 50,
      "average_fill_price": 175.52
    }
    ```

#### `ORDER_REJECTED_EVENT`

-   **Purpose:** Informs the agent that a submitted order was rejected by the broker.
-   **Triggers Transition:** `ENTERING_POSITION` -> `MONITORING_WATCHLIST`.
-   **Payload:**

    ```json
    {
      "order_id": "{broker_order_uuid}",
      "reason": "INSUFFICIENT_FUNDS"
    }
    ```

---

### 3.4. System Health & Manual Override Events

*   **Source:** Monitoring services or the administrative UI.

#### `RISK_LIMIT_BREACH_EVENT`

-   **Purpose:** Generated by the internal risk manager when a global limit (e.g., max daily drawdown) is violated.
-   **Triggers Transition:** `ANY_ACTIVE_STATE` -> `LIQUIDATING_POSITIONS`.
-   **Payload:**

    ```json
    {
      "portfolio_id": "{portfolio_uuid}",
      "limit_breached": "MAX_DAILY_DRAWDOWN",
      "current_value": -6.1,
      "limit_value": -6.0
    }
    ```
