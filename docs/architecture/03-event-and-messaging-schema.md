# Event and Messaging Schema

* **Status:** Proposed
* **Date:** 2025-08-12
* **Deciders:** Pierre GrothÃ©, Tommy (AI Assistant)

## 1. Context

In our Event-Driven Architecture (EDA), the agent's Finite State Machine (FSM) is driven by a stream of events from various producers (market data handlers, signal generators, the broker API wrapper, etc.). To ensure a decoupled yet reliable system, we must establish a formal, versioned schema for these events. This document defines that schema, acting as the API contract between all components of the trading system.

All events will be JSON objects with a consistent header and a variable `payload`.

```json
{
  "event_id": "{uuid}",
  "event_type": "EVENT_NAME",
  "source": "{source_component_name}", // e.g., "MarketData.NASDAQ", "RiskManager"
  "timestamp_utc": "...",
  "payload": { ... } 
}
```

---

## 2. Time-Based Events (The Pacemaker)

* **Source:** A central scheduler service.

### `MARKET_OPEN_EVENT`

- **Purpose:** Signals the official start of the main trading session for a specific exchange.
* **Triggers Transition:** `AWAITING_MARKET_OPEN` -> `MONITORING_WATCHLIST`.
* **Payload:**

    ```json
    {
      "exchange_id": "NASDAQ"
    }
    ```

### `END_OF_DAY_WARNING_EVENT`

- **Purpose:** Initiates the mandatory end-of-day liquidation process.
* **Triggers Transition:** `MONITORING_WATCHLIST` or `MANAGING_POSITION` -> `LIQUIDATING_POSITIONS`.
* **Payload:**

    ```json
    {
      "exchange_id": "NASDAQ"
    }
    ```

---

## 3. Signal & Analysis Events

* **Source:** The `MarketAnalystPipeline`.

### `ENTRY_SIGNAL_TRIGGERED`

- **Purpose:** Informs the FSM that a high-probability trading setup has been identified from the watchlist.
* **Triggers Transition:** `MONITORING_WATCHLIST` -> `ENTERING_POSITION`.
* **Payload:** The full `StockCandidateObject` for the identified trade.

    ```json
    {
      "signal_id": "{signal_uuid}",
      "ticker": "AAPL",
      "exchange_id": "NASDAQ",
      "direction": "LONG", // Inferred from strategy/catalyst
      "entry_confidence": 0.85, // From the ML meta-model
      "strategy_id": "ORB_v1",
      // ... other fields from the StockCandidateObject
    }
    ```

---

## 4. Broker & Order Management Events (Feedback Loop)

* **Source:** The Broker API wrapper service.

### `ORDER_FILL_CONFIRMATION`

- **Purpose:** Confirms that an order has been partially or fully executed by the broker.
* **Triggers Transition:**
  * On entry order: `ENTERING_POSITION` -> `MANAGING_POSITION`.
  * On exit order: `EXITING_POSITION` -> `MONITORING_WATCHLIST`.
* **Payload:**

    ```json
    {
      "order_id": "{broker_order_uuid}",
      "trade_id": "{trade_uuid}",
      "portfolio_id": "{portfolio_uuid}",
      "fill_status": "PARTIAL" or "FULL",
      "filled_quantity": 50,
      "remaining_quantity": 50,
      "average_fill_price": 175.52
    }
    ```

### `ORDER_REJECTED_EVENT`

- **Purpose:** Informs the agent that a submitted order was rejected by the broker.
* **Triggers Transition:** `ENTERING_POSITION` -> `MONITORING_WATCHLIST`.
* **Payload:**

    ```json
    {
      "order_id": "{broker_order_uuid}",
      "reason": "INSUFFICIENT_FUNDS"
    }
    ```

---

## 5. System Health & Manual Override Events

* **Source:** Monitoring services or the administrative UI.

### `RISK_LIMIT_BREACH_EVENT`

- **Purpose:** Generated by the internal risk manager when a global limit (e.g., max daily drawdown) is violated.
* **Triggers Transition:** `ANY_ACTIVE_STATE` -> `LIQUIDATING_POSITIONS`.
* **Payload:**

    ```json
    {
      "portfolio_id": "{portfolio_uuid}",
      "limit_breached": "MAX_DAILY_DRAWDOWN",
      "current_value": -6.1,
      "limit_value": -6.0
    }
    ```
